import json
import glob
from datetime import datetime

def load_data_from_files(file_pattern):
    all_data = []
    for file_name in glob.glob(file_pattern):
        with open(file_name, 'r') as file:
            data = json.load(file)
            all_data.extend(data)
    return all_data

def add_occurrences_and_date(data):
    for port_data in data:
        # Adding occurrence field
        port_data['occurrence'] = len(port_data['vulnerabilities'])
        # Adding generated_date field
        port_data['generated'] = datetime.now().strftime("%Y-%m-%d")
    return data

def sort_by_port(data):
    return sorted(data, key=lambda x: int(x['port']), reverse=False)

def save_to_file(data, filename):
    with open(filename, 'w') as file:
        json.dump(data, file, indent=4)

def main():
    file_pattern = "port_vulns_db_*.json"
    data = load_data_from_files(file_pattern)
    updated_data = add_occurrences_and_date(data)
    sorted_data = sort_by_port(updated_data)
    save_to_file(sorted_data, "port_vulns_db.json")

if __name__ == "__main__":
    main()
